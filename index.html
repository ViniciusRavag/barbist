<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BarberPro</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root { --primary: #8e44ad; --dark: #2c3e50; }
    body { background: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .navbar { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .card { border-radius: 12px; transition: transform 0.3s; margin-bottom: 1.5rem; }
    .card:hover { transform: translateY(-5px); }
    .service-card { border-left: 4px solid var(--primary); }
    .admin-sidebar { background: var(--dark); height: 100vh; position: fixed; }
    .main-content { margin-left: 280px; }
    .time-slot { cursor: pointer; transition: all 0.2s; }
    .time-slot:hover { background: #e8daff; }
    .status-pending { color: #e67e22; }
    .status-confirmed { color: #27ae60; }
    .status-completed { color: #2c3e50; opacity: 0.7; }
    .status-canceled { color: #e74c3c; text-decoration: line-through; }
    @media (max-width: 992px) {
      .admin-sidebar { width: 220px; }
      .main-content { margin-left: 220px; }
    }
    @media (max-width: 768px) {
      .admin-sidebar { width: 100%; height: auto; position: relative; }
      .main-content { margin-left: 0; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">
        <i class="bi bi-scissors me-2"></i>BarberPro
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item" id="navServices">
            <a class="nav-link active" href="#"><i class="bi bi-list me-1"></i>Serviços</a>
          </li>
          <li class="nav-item" id="navBooking">
            <a class="nav-link" href="#"><i class="bi bi-calendar-check me-1"></i>Agendar</a>
          </li>
          <li class="nav-item" id="navAdmin">
            <a class="nav-link" href="?view=admin"><i class="bi bi-speedometer2 me-1"></i>Admin</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-4" id="mainContent">
    <!-- Will be populated dynamically -->
  </div>

  <!-- Admin Sidebar -->
  <div class="admin-sidebar d-none d-lg-block position-fixed top-0 start-0 p-3 text-white" id="adminSidebar">
    <h4 class="mb-4"><i class="bi bi-tools me-2"></i>Painel Admin</h4>
    <ul class="nav flex-column">
      <li class="nav-item mb-2">
        <a class="nav-link text-white d-flex align-items-center active" href="#" id="adminDashboard">
          <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </a>
      </li>
      <li class="nav-item mb-2">
        <a class="nav-link text-white d-flex align-items-center" href="#" id="adminAppointments">
          <i class="bi bi-calendar-week me-2"></i>Agendamentos
        </a>
      </li>
      <li class="nav-item mb-2">
        <a class="nav-link text-white d-flex align-items-center" href="#" id="adminServices">
          <i class="bi bi-scissors me-2"></i>Serviços
        </a>
      </li>
      <li class="nav-item mb-2">
        <a class="nav-link text-white d-flex align-items-center" href="#" id="adminReports">
          <i class="bi bi-bar-chart me-2"></i>Relatórios
        </a>
      </li>
    </ul>
    <div class="mt-5 p-3 bg-dark rounded">
      <h6 class="mb-3">Status em Tempo Real</h6>
      <div class="d-flex justify-content-between mb-2">
        <span>Pendentes:</span>
        <span id="pendingCount" class="badge bg-warning">0</span>
      </div>
      <div class="d-flex justify-content-between">
        <span>Hoje:</span>
        <span id="todayCount" class="badge bg-success">0</span>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title"><i class="bi bi-calendar-plus me-2"></i>Novo Agendamento</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="bookingForm">
            <div class="mb-3">
              <label class="form-label">Serviço</label>
              <select class="form-select" id="serviceSelect" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Data</label>
              <input type="date" class="form-control" id="bookingDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Horário</label>
              <div id="timeSlots" class="d-grid gap-2"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">Nome do Cliente</label>
              <input type="text" class="form-control" id="clientName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Telefone</label>
              <input type="tel" class="form-control" id="clientPhone" required placeholder="(00) 00000-0000">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="bookingForm" class="btn btn-dark">Confirmar Agendamento</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="serviceModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Novo Serviço</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="serviceForm">
            <div class="mb-3">
              <label class="form-label">Nome do Serviço</label>
              <input type="text" class="form-control" id="serviceName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Duração (minutos)</label>
              <input type="number" class="form-control" id="serviceDuration" min="15" step="15" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Preço (R$)</label>
              <input type="number" class="form-control" id="servicePrice" step="0.50" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Descrição</label>
              <textarea class="form-control" id="serviceDescription" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="serviceForm" class="btn btn-dark">Salvar Serviço</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Firebase Config - REPLACE WITH YOUR CONFIG
    const firebaseConfig = {
      apiKey: "SEU_API_KEY",
      authDomain: "seu-projeto.firebaseapp.com",
      projectId: "seu-projeto",
      storageBucket: "seu-projeto.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // DOM Elements
    const mainContent = document.getElementById('mainContent');
    const adminSidebar = document.getElementById('adminSidebar');
    const navAdmin = document.getElementById('navAdmin');
    const urlParams = new URLSearchParams(window.location.search);
    const isAdminView = urlParams.get('view') === 'admin';
    
    // Initialize App
    document.addEventListener('DOMContentLoaded', () => {
      setupRouting();
      setupEventListeners();
      
      if (isAdminView) {
        loadAdminView();
      } else {
        loadCustomerView();
      }
    });

    // Routing System
    function setupRouting() {
      navAdmin.addEventListener('click', (e) => {
        e.preventDefault();
        window.history.pushState({}, '', '?view=admin');
        loadAdminView();
      });
      
      document.getElementById('navServices').addEventListener('click', (e) => {
        e.preventDefault();
        window.history.pushState({}, '', '/');
        loadCustomerView();
      });
      
      document.getElementById('navBooking').addEventListener('click', (e) => {
        e.preventDefault();
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        loadAvailableServices().then(() => bookingModal.show());
      });
      
      window.addEventListener('popstate', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('view') === 'admin') {
          loadAdminView();
        } else {
          loadCustomerView();
        }
      });
    }

    // Event Listeners
    function setupEventListeners() {
      // Booking Form
      document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
      document.getElementById('bookingDate').addEventListener('change', loadTimeSlots);
      
      // Service Form
      document.getElementById('serviceForm').addEventListener('submit', handleServiceSubmit);
      
      // Admin Navigation
      document.getElementById('adminDashboard').addEventListener('click', loadAdminDashboard);
      document.getElementById('adminAppointments').addEventListener('click', loadAdminAppointments);
      document.getElementById('adminServices').addEventListener('click', loadAdminServices);
    }

    // Customer View
    async function loadCustomerView() {
      adminSidebar.classList.add('d-none');
      document.querySelector('.main-content')?.classList.remove('main-content');
      
      mainContent.innerHTML = `
        <div class="text-center my-5">
          <h1 class="display-4 fw-bold mb-4">BarberPro</h1>
          <p class="lead text-muted mb-5">O melhor corte da cidade com agendamento fácil e rápido</p>
        </div>
        
        <div class="row mb-5" id="servicesContainer">
          <div class="text-center mb-4">
            <h2 class="fw-bold text-dark">Nossos Serviços</h2>
            <p class="text-muted">Profissionais especializados para o seu melhor visual</p>
          </div>
        </div>
        
        <div class="bg-dark text-white rounded-4 p-5 text-center mt-5">
          <h3 class="mb-4">Horários Flexíveis</h3>
          <p class="mb-4">Agende seu horário com antecedência e garanta seu lugar</p>
          <button class="btn btn-light btn-lg fw-bold px-5 py-3" id="openBookingBtn">
            <i class="bi bi-calendar-check me-2"></i>Agendar Agora
          </button>
        </div>
      `;
      
      // Load services
      await loadServices();
      
      // Setup booking button
      document.getElementById('openBookingBtn').addEventListener('click', async () => {
        await loadAvailableServices();
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        bookingModal.show();
      });
    }

    // Load Services for Customers
    async function loadServices() {
      const servicesContainer = document.getElementById('servicesContainer');
      servicesContainer.innerHTML += '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"></div></div>';
      
      try {
        const servicesRef = db.collection('services').where('active', '==', true);
        const snapshot = await servicesRef.get();
        
        if (snapshot.empty) {
          servicesContainer.innerHTML = '<p class="text-center text-muted">Nenhum serviço disponível no momento</p>';
          return;
        }
        
        let servicesHTML = '';
        snapshot.forEach(doc => {
          const service = doc.data();
          servicesHTML += `
            <div class="col-md-4 mb-4">
              <div class="card service-card shadow-sm h-100">
                <div class="card-body">
                  <h5 class="card-title fw-bold">${service.name}</h5>
                  <p class="card-text text-muted">${service.description || 'Serviço profissional de qualidade'}</p>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <span class="fw-bold text-primary">R$ ${parseFloat(service.price).toFixed(2)}</span>
                    <span class="badge bg-primary">${service.duration} min</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        
        servicesContainer.innerHTML = `
          <div class="text-center mb-4">
            <h2 class="fw-bold text-dark">Nossos Serviços</h2>
            <p class="text-muted">Profissionais especializados para o seu melhor visual</p>
          </div>
          <div class="row">${servicesHTML}</div>
        `;
      } catch (error) {
        console.error('Error loading services:', error);
        servicesContainer.innerHTML = '<p class="text-center text-danger">Erro ao carregar serviços. Tente novamente mais tarde.</p>';
      }
    }

    // Admin View
    function loadAdminView() {
      adminSidebar.classList.remove('d-none');
      mainContent.innerHTML = '<div class="main-content p-4" id="adminMainContent"><div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div></div>';
      
      loadAdminDashboard();
      
      // Update admin navigation
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      document.getElementById('adminDashboard').classList.add('active');
    }

    // Admin Dashboard
    async function loadAdminDashboard() {
      const adminMain = document.getElementById('adminMainContent');
      adminMain.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="fw-bold"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-dark" id="refreshData">
              <i class="bi bi-arrow-repeat"></i> Atualizar
            </button>
          </div>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white border-0">
              <div class="card-body">
                <h5 class="card-title">Hoje</h5>
                <h2 class="display-5 fw-bold" id="todayTotal">0</h2>
                <p class="mb-0">agendamentos</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-warning text-white border-0">
              <div class="card-body">
                <h5 class="card-title">Pendentes</h5>
                <h2 class="display-5 fw-bold" id="pendingTotal">0</h2>
                <p class="mb-0">aguardando confirmação</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-success text-white border-0">
              <div class="card-body">
                <h5 class="card-title">Concluídos</h5>
                <h2 class="display-5 fw-bold" id="completedTotal">0</h2>
                <p class="mb-0">hoje</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card bg-info text-white border-0">
              <div class="card-body">
                <h5 class="card-title">Faturamento</h5>
                <h2 class="display-5 fw-bold" id="revenueTotal">R$ 0,00</h2>
                <p class="mb-0">hoje</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card mb-4">
          <div class="card-header bg-dark text-white fw-bold">
            <i class="bi bi-calendar-week me-2"></i>Próximos Agendamentos
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="upcomingAppointments">
                <thead>
                  <tr>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Serviço</th>
                    <th>Status</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      await loadDashboardData();
      document.getElementById('refreshData').addEventListener('click', loadDashboardData);
    }

    // Load Dashboard Data
    async function loadDashboardData() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      try {
        // Today's appointments
        const todayRef = db.collection('appointments')
          .where('date', '==', today.toISOString().split('T')[0]);
        
        const todaySnapshot = await todayRef.get();
        const todayAppointments = todaySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        // Pending appointments
        const pendingRef = db.collection('appointments')
          .where('status', '==', 'pending')
          .orderBy('date', 'asc')
          .limit(5);
        
        const pendingSnapshot = await pendingRef.get();
        
        // Update counters
        document.getElementById('todayTotal').textContent = todayAppointments.length;
        document.getElementById('pendingTotal').textContent = pendingSnapshot.size;
        
        // Calculate completed today
        const completedToday = todayAppointments.filter(appt => appt.status === 'completed').length;
        document.getElementById('completedTotal').textContent = completedToday;
        
        // Calculate revenue
        const revenue = todayAppointments
          .filter(appt => appt.status === 'completed')
          .reduce((sum, appt) => sum + parseFloat(appt.price), 0);
        document.getElementById('revenueTotal').textContent = `R$ ${revenue.toFixed(2)}`;
        
        // Update sidebar counters
        document.getElementById('pendingCount').textContent = pendingSnapshot.size;
        document.getElementById('todayCount').textContent = todayAppointments.length;
        
        // Load upcoming appointments table
        loadUpcomingTable(todayAppointments);
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Load Upcoming Appointments Table
    function loadUpcomingTable(appointments) {
      const tableBody = document.querySelector('#upcomingAppointments tbody');
      tableBody.innerHTML = '';
      
      if (appointments.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum agendamento para hoje</td></tr>';
        return;
      }
      
      // Sort by time
      appointments.sort((a, b) => a.time.localeCompare(b.time));
      
      appointments.slice(0, 5).forEach(appt => {
        const statusClass = `status-${appt.status}`;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="fw-bold">${appt.time}</td>
          <td>${appt.clientName}</td>
          <td>${appt.serviceName}</td>
          <td><span class="fw-bold ${statusClass}">${formatStatus(appt.status)}</span></td>
          <td>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-success confirm-btn" data-id="${appt.id}" ${appt.status !== 'pending' ? 'disabled' : ''}>
                <i class="bi bi-check-lg"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger cancel-btn" data-id="${appt.id}" ${appt.status !== 'pending' ? 'disabled' : ''}>
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      // Add event listeners to buttons
      document.querySelectorAll('.confirm-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.closest('button').dataset.id;
          await updateAppointmentStatus(id, 'confirmed');
          loadDashboardData();
        });
      });
      
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.target.closest('button').dataset.id;
          await updateAppointmentStatus(id, 'canceled');
          loadDashboardData();
        });
      });
    }

    // Helper Functions
    function formatStatus(status) {
      const statuses = {
        pending: 'Pendente',
        confirmed: 'Confirmado',
        completed: 'Concluído',
        canceled: 'Cancelado'
      };
      return statuses[status] || status;
    }

    async function updateAppointmentStatus(id, status) {
      try {
        await db.collection('appointments').doc(id).update({ status });
      } catch (error) {
        console.error('Error updating appointment:', error);
        alert('Erro ao atualizar agendamento. Tente novamente.');
      }
    }

    // Booking Functions
    async function loadAvailableServices() {
      const serviceSelect = document.getElementById('serviceSelect');
      serviceSelect.innerHTML = '<option value="" disabled selected>Selecione um serviço...</option>';
      
      try {
        const servicesRef = db.collection('services').where('active', '==', true).orderBy('name');
        const snapshot = await servicesRef.get();
        
        snapshot.forEach(doc => {
          const service = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${service.name} - R$ ${parseFloat(service.price).toFixed(2)} (${service.duration} min)`;
          option.dataset.duration = service.duration;
          option.dataset.price = service.price;
          serviceSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading services for booking:', error);
      }
    }

    async function loadTimeSlots() {
      const dateInput = document.getElementById('bookingDate');
      const serviceSelect = document.getElementById('serviceSelect');
      const timeSlotsContainer = document.getElementById('timeSlots');
      
      if (!dateInput.value || !serviceSelect.value) return;
      
      const selectedDate = new Date(dateInput.value);
      const today = new Date();
      
      // Validate date (not in past)
      if (selectedDate < today.setHours(0,0,0,0)) {
        alert('Não é possível agendar para datas passadas');
        dateInput.value = '';
        return;
      }
      
      timeSlotsContainer.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm" role="status"></div></div>';
      
      try {
        // Working hours (8AM - 7PM)
        const startHour = 8;
        const endHour = 19;
        const serviceDuration = parseInt(serviceSelect.selectedOptions[0].dataset.duration);
        
        // Get existing appointments for this date
        const dateStr = dateInput.value;
        const existingRef = db.collection('appointments')
          .where('date', '==', dateStr)
          .where('status', 'in', ['pending', 'confirmed', 'completed']);
        
        const existingSnapshot = await existingRef.get();
        const bookedSlots = existingSnapshot.docs.map(doc => doc.data().time);
        
        // Generate available slots
        let currentTime = startHour * 60;
        const slots = [];
        
        while (currentTime + serviceDuration <= endHour * 60) {
          const hour = Math.floor(currentTime / 60);
          const minutes = currentTime % 60;
          const timeStr = `${hour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
          
          if (!bookedSlots.includes(timeStr)) {
            slots.push(timeStr);
          }
          
          currentTime += 30; // 30-minute intervals
        }
        
        // Render slots
        if (slots.length === 0) {
          timeSlotsContainer.innerHTML = '<p class="text-center text-muted mt-2">Nenhum horário disponível para esta data</p>';
          return;
        }
        
        timeSlotsContainer.innerHTML = slots.map(time => `
          <button class="btn btn-outline-primary time-slot p-3" type="button" data-time="${time}">
            ${time}
          </button>
        `).join('');
        
        // Add click handlers
        document.querySelectorAll('.time-slot').forEach(slot => {
          slot.addEventListener('click', () => {
            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('active', 'btn-dark'));
            slot.classList.add('active', 'btn-dark');
            document.getElementById('bookingTime').value = slot.dataset.time;
          });
        });
        
      } catch (error) {
        console.error('Error loading time slots:', error);
        timeSlotsContainer.innerHTML = '<p class="text-center text-danger mt-2">Erro ao carregar horários. Tente outra data.</p>';
      }
    }

    async function handleBookingSubmit(e) {
      e.preventDefault();
      const form = e.target;
      
      // Validation
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      const selectedService = form.serviceSelect.selectedOptions[0];
      const timeSlot = document.querySelector('.time-slot.active');
      
      if (!timeSlot) {
        alert('Por favor, selecione um horário');
        return;
      }
      
      try {
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" aria-hidden="true"></span> Agendando...';
        
        // Create appointment
        await db.collection('appointments').add({
          serviceName: selectedService.text.split(' - ')[0],
          serviceId: form.serviceSelect.value,
          price: parseFloat(selectedService.dataset.price),
          date: form.bookingDate.value,
          time: timeSlot.dataset.time,
          clientName: form.clientName.value.trim(),
          clientPhone: form.clientPhone.value.replace(/\D/g, ''),
          status: 'pending',
          createdAt: new Date()
        });
        
        // Success
        form.reset();
        const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
        bookingModal.hide();
        
        // Show confirmation
        alert('Agendamento realizado com sucesso! Você receberá uma confirmação em breve.');
        
        // Reset form state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        form.classList.remove('was-validated');
        
      } catch (error) {
        console.error('Error creating appointment:', error);
        alert('Erro ao agendar. Por favor, tente novamente mais tarde.');
        
        // Reset button state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    }

    // Admin Services Management
    async function loadAdminServices() {
      const adminMain = document.getElementById('adminMainContent');
      adminMain.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="fw-bold"><i class="bi bi-scissors me-2"></i>Gerenciar Serviços</h2>
          <button class="btn btn-dark" id="addServiceBtn">
            <i class="bi bi-plus-circle me-2"></i>Novo Serviço
          </button>
        </div>
        
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>Serviço</th>
                <th>Duração</th>
                <th>Preço</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="servicesTableBody">
              <tr>
                <td colspan="5" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      `;
      
      document.getElementById('addServiceBtn').addEventListener('click', () => {
        document.getElementById('serviceForm').reset();
        const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
        serviceModal.show();
      });
      
      await loadServicesTable();
    }

    async function loadServicesTable() {
      const tableBody = document.getElementById('servicesTableBody');
      
      try {
        const servicesRef = db.collection('services').orderBy('name');
        const snapshot = await servicesRef.get();
        
        if (snapshot.empty) {
          tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum serviço cadastrado</td></tr>';
          return;
        }
        
        let html = '';
        snapshot.forEach(doc => {
          const service = doc.data();
          html += `
            <tr>
              <td class="fw-bold">${service.name}</td>
              <td>${service.duration} minutos</td>
              <td class="fw-bold">R$ ${parseFloat(service.price).toFixed(2)}</td>
              <td>
                <span class="badge bg-${service.active ? 'success' : 'secondary'}">
                  ${service.active ? 'Ativo' : 'Inativo'}
                </span>
              </td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${doc.id}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${doc.id}" ${service.active ? 'disabled' : ''}>
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        });
        
        tableBody.innerHTML = html;
        
        // Add event listeners
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.closest('button').dataset.id;
            await loadServiceForEdit(id);
            const serviceModal = new bootstrap.Modal(document.getElementById('serviceModal'));
            serviceModal.show();
          });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            if (confirm('Tem certeza que deseja excluir este serviço? Esta ação não pode ser desfeita.')) {
              const id = e.target.closest('button').dataset.id;
              await deleteService(id);
              loadServicesTable();
            }
          });
        });
        
      } catch (error) {
        console.error('Error loading services table:', error);
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar serviços</td></tr>';
      }
    }

    async function handleServiceSubmit(e) {
      e.preventDefault();
      const form = e.target;
      
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      
      try {
        const serviceData = {
          name: form.serviceName.value.trim(),
          duration: parseInt(form.serviceDuration.value),
          price: parseFloat(form.servicePrice.value),
          description: form.serviceDescription.value.trim() || null,
          active: true,
          createdAt: new Date()
        };
        
        // Check if we're editing
        const serviceId = form.dataset.editingId;
        if (serviceId) {
          await db.collection('services').doc(serviceId).update(serviceData);
          delete form.dataset.editingId;
        } else {
          await db.collection('services').add(serviceData);
        }
        
        // Close modal and reload table
        const serviceModal = bootstrap.Modal.getInstance(document.getElementById('serviceModal'));
        serviceModal.hide();
        form.reset();
        form.classList.remove('was-validated');
        
        if (isAdminView) loadAdminServices();
        
      } catch (error) {
        console.error('Error saving service:', error);
        alert('Erro ao salvar serviço. Verifique os dados e tente novamente.');
      }
    }

    async function loadServiceForEdit(id) {
      try {
        const doc = await db.collection('services').doc(id).get();
        if (!doc.exists) return;
        
        const service = doc.data();
        const form = document.getElementById('serviceForm');
        
        form.serviceName.value = service.name;
        form.serviceDuration.value = service.duration;
        form.servicePrice.value = service.price;
        form.serviceDescription.value = service.description || '';
        form.dataset.editingId = id;
        
        // Change modal title
        document.querySelector('#serviceModal .modal-title').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Editar Serviço';
      } catch (error) {
        console.error('Error loading service for edit:', error);
      }
    }

    async function deleteService(id) {
      try {
        await db.collection('services').doc(id).delete();
      } catch (error) {
        console.error('Error deleting service:', error);
        throw error;
      }
    }
  </script>
</body>
</html>
